# https://circleci.com/docs/configuration#machine
machine:
  php:
    version: 5.5.11
  # https://circleci.com/docs/environment#databases
  services:
    - redis
  environment: 
    # https://circleci.com/docs/config-sample#sample
    DATABASE_URL: mysql://ubuntu:@127.0.0.1:5432/circle_test 
    DB_ENCODE: 'utf8'
    MODULE_PATH: 'sites/all/modules'
    BUILD_DIR: 'build_dir'
  
dependencies: 
  # Install additional test dependencies here (like drush, terminus, redis, Behat, etc).
  pre: 
    # Install Drush.
    - composer global require drush/drush:6.2.0 
    # Install Terminus.
    - git clone https://github.com/pantheon-systems/terminus.git $HOME/.drush/terminus
    - cd $HOME/.drush/terminus 
    - drush cc drush 
  override: 
    # We cannot be in a Drupal directory to run aliased drush commands.
    - cd $HOME 
    - mkdir $BUILD_DIR
    - mkdir -p $BUILD_DIR/$MODULE_PATH
    - cd $BUILD_DIR 
    - pwd
    # - git archive $(git rev-parse --abbrev-ref HEAD) | tar -x -C $MODULE_PATH
    - drush --yes site-install minimal --db-url="$DATABASE_URL" 
    - drush --yes en simpletest
 
test:
  override:
    #
    # This is where you run your tests, be they SimpleTest, Casper, Behat,
    # or otherwise. Here's a SimpleTest example. I've found that drush
    # likes to exit with odd codes if you run multiple classes at once.
    # You may have to run one class at a time.
    #
    # - drush @pantheon.$PNAME.$PSITE test-run MyTestClass --strict=0
    # - drush @pantheon.$PNAME.$PSITE test-run MyTestClass2 --strict=0
  post:
  # Destroy the Pantheon environment 

# notifications:
#  email:
#    recipients: 
#    on_success: always
#    on_failure: always
